<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Voxel FPS Multiplayer</title>
<style>
body { margin:0; overflow:hidden; background:#222; color:white; font-family:sans-serif; }
#homeScreen { position:absolute; top:0; left:0; width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; background:#222; z-index:10; }
#roomIdDisplay { position:absolute; top:10px; left:10px; color:white; font-weight:bold; z-index:10; }
#playerNameContainer { position:absolute; top:10px; right:10px; z-index:10; color:white; }
#inventory { position:absolute; bottom:20px; right:20px; display:flex; gap:5px; z-index:10; }
.slot { width:80px; height:60px; background:rgba(0,0,0,0.6); color:white; display:flex; align-items:center; justify-content:center; border:2px solid white; font-size:12px; user-select:none; }
.selected { border-color:yellow; }
#crosshair { position:absolute; top:50%; left:50%; width:10px; height:10px; margin-left:-5px; margin-top:-5px; background:red; z-index:10; }
canvas#gameCanvas { position:absolute; top:0; left:0; width:100%; height:100%; display:block; z-index:1; }
</style>
</head>
<body>

<div id="homeScreen">
  <h1>Voxel FPS</h1>
  <button id="createRoom">部屋を作る</button>
  <div style="margin-top:20px;">
    <input type="text" id="roomIdInput" placeholder="部屋ID">
    <button id="joinRoom">参加する</button>
  </div>
</div>

<div id="roomIdDisplay"></div>

<div id="playerNameContainer">
  <label for="playerNameInput">名前:</label>
  <input type="text" id="playerNameInput" placeholder="Player">
</div>

<div id="inventory">
  <div class="slot selected" data-weapon="Assault Rifle">Assault Rifle</div>
  <div class="slot" data-weapon="Pistol">Pistol</div>
  <div class="slot" data-weapon="Sniper Rifle">Sniper Rifle</div>
</div>

<div id="crosshair"></div>
<canvas id="gameCanvas"></canvas>

<script type="module">
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.162.0/build/three.module.js';

// ===== ワールド生成 =====
function createWorld(){
  const sizeX=64,sizeZ=64,heightBase=4;
  const boxes=[];
  for(let x=0;x<sizeX;x++){
    for(let z=0;z<sizeZ;z++){
      const hill=Math.floor(2*Math.sin(x*0.3)+2*Math.cos(z*0.25));
      const h=Math.max(1,heightBase+hill);
      for(let y=0;y<h;y++) boxes.push({x,y,z});
    }
  }
  const geo=new THREE.BoxGeometry(1,1,1);
  const mat=new THREE.MeshLambertMaterial({color:0x55aa55});
  const mesh=new THREE.InstancedMesh(geo,mat,boxes.length);
  const m=new THREE.Matrix4();
  boxes.forEach((b,i)=>{ m.makeTranslation(b.x,b.y,b.z); mesh.setMatrixAt(i,m); });
  mesh.instanceMatrix.needsUpdate=true;
  const solid=new Set(boxes.map(b=>`${b.x},${b.y},${b.z}`));
  return {mesh,collider:{solid}};
}

// ===== HTML要素 =====
const homeScreen=document.getElementById('homeScreen');
const gameCanvas=document.getElementById('gameCanvas');
const createRoomBtn=document.getElementById('createRoom');
const joinRoomBtn=document.getElementById('joinRoom');
const roomIdInput=document.getElementById('roomIdInput');
const roomIdDisplay=document.getElementById('roomIdDisplay');
const playerNameInput=document.getElementById('playerNameInput');
let roomId;
let playerName='Player';
playerNameInput.addEventListener('input',e=>playerName=e.target.value||'Player');

// ===== インベントリ =====
let inventory=['Assault Rifle','Pistol','Sniper Rifle'];
let selectedIndex=0;
let selectedWeapon=inventory[selectedIndex];
const slots=document.querySelectorAll('.slot');
function updateInventoryUI(){ slots.forEach((s,i)=>s.classList.toggle('selected',i===selectedIndex)); }
slots.forEach((s,i)=>s.addEventListener('click',()=>{ selectedIndex=i; selectedWeapon=inventory[i]; updateInventoryUI(); }));
window.addEventListener('wheel',e=>{ selectedIndex=(e.deltaY<0)?(selectedIndex-1+inventory.length)%inventory.length:(selectedIndex+1)%inventory.length; selectedWeapon=inventory[selectedIndex]; updateInventoryUI(); });
window.addEventListener('keydown',e=>{ if(e.code==='Digit1') selectedIndex=0; else if(e.code==='Digit2') selectedIndex=1; else if(e.code==='Digit3') selectedIndex=2; else return; selectedWeapon=inventory[selectedIndex]; updateInventoryUI(); });

// ===== ホーム画面操作 =====
function startGame(id,isHost){
  homeScreen.style.display='none';
  gameCanvas.style.display='block';
  roomIdDisplay.textContent='Room: '+id;
  initGame(id,isHost);
}
createRoomBtn.addEventListener('click',()=>{ roomId=Math.random().toString(36).substr(2,6); startGame(roomId,true); });
joinRoomBtn.addEventListener('click',()=>{ roomId=roomIdInput.value.trim(); if(roomId) startGame(roomId,false); });

// ===== ゲーム初期化 =====
function initGame(roomId,isHost){
  const scene=new THREE.Scene();
  scene.background=new THREE.Color(0x87ceeb);
  const camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,0.1,1000);
  const renderer=new THREE.WebGLRenderer({canvas:gameCanvas});
  renderer.setSize(window.innerWidth,window.innerHeight);

  const hemi=new THREE.HemisphereLight(0xffffff,0x444444,1.0); hemi.position.set(0,200,0); scene.add(hemi);
  const dir=new THREE.DirectionalLight(0xffffff,0.8); dir.position.set(100,200,100); scene.add(dir);

  const world=createWorld(); scene.add(world.mesh);

  // ===== Playerクラス =====
  class Player{
    constructor(pos,color=0xED1C24){
      this.pos = pos.clone();
      this.vel = new THREE.Vector3();
      this.onGround = false;
      const geo = new THREE.BoxGeometry(1,2,1);
      const mat = new THREE.MeshLambertMaterial({ color: color });
      this.mesh = new THREE.Mesh(geo,mat);
      scene.add(this.mesh);
    }
  }

  const player = new Player(new THREE.Vector3(8,16,8),0xED1C24);

  // ===== 他プレイヤー管理 =====
  const otherPlayers={};
  function addOrUpdateOtherPlayer(id,pos){
    if(!otherPlayers[id]){
      otherPlayers[id]=new Player(pos,0x0000ff);
    }
    otherPlayers[id].pos.copy(pos);
    otherPlayers[id].mesh.position.set(pos.x,pos.y-1,pos.z);
  }

  // 仮にテスト用で他プレイヤーをランダムに動かす
  let testOtherId='other1';
  addOrUpdateOtherPlayer(testOtherId,new THREE.Vector3(5,16,5));

  // 入力管理
  const keyState={};
  window.addEventListener('keydown', e=>keyState[e.code]=true);
  window.addEventListener('keyup', e=>keyState[e.code]=false);

  let yaw=0,pitch=0,locked=false;
  const euler=new THREE.Euler(0,0,0,'YXZ');
  const moveDir=new THREE.Vector3();
  let recoilVel=0;

  function shootWeapon(){ 
    if(selectedWeapon==='Assault Rifle') recoilVel=0.2;
    else if(selectedWeapon==='Pistol') recoilVel=0.5;
    else if(selectedWeapon==='Sniper Rifle') recoilVel=0.8;
  }
  document.addEventListener('mousedown', e=>{ if(e.button===0) shootWeapon(); });
  gameCanvas.addEventListener('click', ()=>gameCanvas.requestPointerLock());
  document.addEventListener('pointerlockchange', ()=>{ locked=(document.pointerLockElement===gameCanvas); });
  document.addEventListener('mousemove', e=>{
    if(!locked) return;
    const sens=0.0025;
    yaw -= e.movementX*sens;
    pitch -= e.movementY*sens;
    pitch=Math.max(-Math.PI/2+0.01, Math.min(Math.PI/2-0.01, pitch));
  });

  function collide(pos){
    const px=Math.floor(pos.x+0.5),py=Math.floor(pos.y),pz=Math.floor(pos.z+0.5);
    for(let y=py;y<=py+1;y++){ if(world.collider.solid.has(`${px},${y},${pz}`)) return true; }
    return false;
  }

  function update(dt){
    // 自分プレイヤー移動
    moveDir.set(0,0,0);
    if(keyState['KeyW']) moveDir.z+=1;
    if(keyState['KeyS']) moveDir.z-=1;
    if(keyState['KeyA']) moveDir.x-=1;
    if(keyState['KeyD']) moveDir.x+=1;
    moveDir.normalize();

    const forward=new THREE.Vector3(0,0,-1).applyEuler(euler);
    const right=new THREE.Vector3(1,0,0).applyEuler(euler);
    forward.y=0; right.y=0; forward.normalize(); right.normalize();

    const speed=keyState['ShiftLeft']?12:6;
    const accel=new THREE.Vector3().addScaledVector(forward,moveDir.z*speed).addScaledVector(right,moveDir.x*speed);
    player.vel.x=THREE.MathUtils.damp(player.vel.x,accel.x,15,dt);
    player.vel.z=THREE.MathUtils.damp(player.vel.z,accel.z,15,dt);

    const g=-24; player.vel.y+=g*dt;
    if(keyState['Space']&&player.onGround){ player.vel.y=10; player.onGround=false; }

    const next=player.pos.clone();
    next.x+=player.vel.x*dt; if(collide(next)){ next.x=Math.round(next.x)+(player.vel.x>0?-0.51:0.51); player.vel.x=0; }
    next.z+=player.vel.z*dt; if(collide(next)){ next.z=Math.round(next.z)+(player.vel.z>0?-0.51:0.51); player.vel.z=0; }
    next.y+=player.vel.y*dt;
    if(collide(next)){
      if(player.vel.y<0){ player.onGround=true; player.vel.y=0; next.y=Math.floor(next.y)+1.0; }
      else if(player.vel.y>0){ player.vel.y=0; next.y=Math.ceil(next.y)-0.01; }
    } else player.onGround=false;

    player.pos.copy(next);
    player.mesh.position.set(player.pos.x, player.pos.y-1, player.pos.z);

    // 反動
    pitch-=recoilVel;
    recoilVel=THREE.MathUtils.damp(recoilVel,0,10,dt);
    euler.set(pitch,yaw,0,'YXZ');

    // テスト: 他プレイヤーを簡単に動かす
    const t=Math.sin(performance.now()/1000);
    addOrUpdateOtherPlayer(testOtherId,new THREE.Vector3(5+t*2,16,5+t*2));
  }

  let lastTime=performance.now();
  function animate(){
    const now=performance.now();
    const dt=(now-lastTime)/1000; lastTime=now;
    update(dt);
    renderer.render(scene,camera);
    requestAnimationFrame(animate);
  }
  animate();
}
</script>
</body>
</html>
